import{d as ke,f as Ce,b as m,a as $e,u as qe,g as Te,o as Le,a1 as Ne,a2 as Se,h as r,i,j as T,k as t,w as a,E as De,l as u,y as b,t as d,F as L,B as U,m as p,n as y,p as Me,C as x,N as K,e as J,a3 as Pe,_ as Ve}from"./index.66cc4c36.js";import{e as Be,c as Ie,u as Oe,l as Ue}from"./editor.cc3642af.js";import{J as Fe,F as Ge}from"./fetch.355e1957.js";import{P as He}from"./pageHeader.9328b4bb.js";import{a as je,b as Ae,c as Ee,d as Re,e as Ye}from"./source.09d3a396.js";import{C as xe}from"./common.b6c75224.js";import{c as Ke}from"./impl.317abd33.js";import"./index.d3546514.js";const Je={class:"editor_border"},Qe=b("br",null,null,-1),ze=b("br",null,null,-1),We=ke({__name:"order",setup(Xe){const{t:f}=Ce(),Q={labelCol:{span:6},wrapperCol:{span:18}},S=m(!1),v=m(!1),D=m(1),F=m([]),G=m([]),g=m(!1),H=m(),h=$e(),z=qe(),w=m(!0),{checkStepState:W}=xe();let N=null;const X={data_base:[{required:!0,message:f("common.check.source"),trigger:"change"}],text:[{required:!0,message:f("common.check.text"),trigger:"blur"}]},M=m([]),{col:Z,orderItems:l,tableArch:ee,indexArch:ae}=Fe(),{orderProfileArch:_,editor:k}=Ge(),j=m([]),te=e=>e&&e.valueOf()<x().startOf("day").valueOf(),oe=e=>{const o=x();return e&&e.isSame(o,"day")?{disabledHours:()=>P(0,o.hour()),disabledMinutes:n=>n===o.hour()?P(0,o.add(10,"minute").minute()):[],disabledSeconds:(n,c)=>n===o.hour()&&c===o.minute()?P(0,o.second()):[]}:{}},P=(e,o)=>{const n=[];for(let c=e;c<o;c++)n.push(c);return n},le=e=>{l.delay=e.format("YYYY-MM-DD HH:mm")},ne=async e=>{const{data:o}=await je(l.source_id,e);_.table=o.payload,de()},se=async()=>{S.value=!0;const{data:e}=await Ae(l).then(o=>o).finally(()=>{S.value=!1});F.value=e.payload.rows,G.value=e.payload.idx,D.value=2,K.success(f("order.apply.table.info")+f("common.success"))},re=Te(async e=>{if(e.replace(/(^s*)|(s*$)/g,"").length==0)return;g.value=!g.value;const{data:o}=await Ie({source_id:l.source_id,kind:l.type,data_base:l.data_base,sql:e});let n=0;M.value=o.payload,M.value.forEach(c=>{c.level!==0&&n++}),w.value=n!==0,g.value=!g.value},200),ue=()=>{v.value=!v.value,H.value.validate().then(async()=>{let e=Object.assign({},l);e.sql=k.value.GetValue(),_.timeline.forEach(o=>{e.relevant=e.relevant.concat(o.auditor)}),await Oe(e),w.value=!0}).catch(()=>{K.error(f("order.apply.form.commit"))}).finally(()=>v.value=!v.value)},A=async(e,o,n,c)=>{const{data:C}=await Ye(e,n,o);N=Ue.registerCompletionItemProvider("sql",{provideCompletionItems:(V,$)=>{let q=V.getWordUntilPosition($),B={startLineNumber:$.lineNumber,endLineNumber:$.lineNumber,startColumn:q.startColumn,endColumn:q.endColumn};return{suggestions:Ke(B,[...C.payload,...c])}},triggerCharacters:["."]}),n||(j.value=C.payload)},de=async()=>{N!==null&&N.dispose(),A(l.source_id,l.data_base,!0,j.value)},ce=async()=>{A(l.source_id,l.source_id,!1,[])},ie=async()=>{const{data:e}=await Ee(l.source_id,!0);_.db=e.payload},me=async()=>{const{data:e}=await Re(l.source_id,"");e.code===5555?J.go(-1):_.timeline=e.payload};return Le(()=>{l.type=parseInt(h.query.type),l.idc=h.query.idc,l.source=h.query.source,l.source_id=h.query.source_id,ie(),me(),ce(),h.query.remark==="true"&&k.value.ChangeEditorText(z.state.common.sql),window.onbeforeunload=function(){if(k.value.GetValue()!=="")return f("common.leave")}}),Ne((e,o,n)=>{k.value.GetValue()!==""?Pe.warn({content:f("common.leave"),onOk:()=>{n()},onCancel:()=>{J.go(11)},okCancel:!0}):n()}),Se(()=>{window.onbeforeunload=null,N.dispose()}),(e,o)=>{const n=r("a-form-item"),c=r("a-select-option"),C=r("a-select"),V=r("a-textarea"),$=r("a-date-picker"),q=r("a-radio"),B=r("a-radio-group"),E=r("a-button"),pe=r("a-space"),fe=r("a-form"),R=r("a-card"),Y=r("a-col"),I=r("a-table"),_e=r("a-spin"),O=r("a-tab-pane"),be=r("a-tabs"),ye=r("a-tooltip"),ve=r("a-step"),ge=r("a-steps"),he=r("a-row");return i(),T(L,null,[t(He,{title:e.$t("order.apply.commit.title"),"sub-title":e.$t("order.apply.commit.desc")},null,8,["title","sub-title"]),t(he,{gutter:24,type:"flex",justify:"center"},{default:a(()=>[t(Y,{md:24,xl:6},{default:a(()=>[t(R,null,{default:a(()=>[t(fe,De(Q,{ref_key:"formRef",ref:H,model:u(l),rules:X}),{default:a(()=>[t(n,{label:e.$t("common.table.type")},{default:a(()=>[b("span",null,d(u(l).type===0?"DDL":"DML"),1)]),_:1},8,["label"]),t(n,{label:e.$t("common.table.env")},{default:a(()=>[b("span",null,d(u(l).idc),1)]),_:1},8,["label"]),t(n,{label:e.$t("common.table.source")},{default:a(()=>[b("span",null,d(u(l).source),1)]),_:1},8,["label"]),t(n,{label:e.$t("common.table.schema"),name:"data_base"},{default:a(()=>[t(C,{value:u(l).data_base,"onUpdate:value":o[0]||(o[0]=s=>u(l).data_base=s),"dropdown-match-select-width":!1,"show-search":"",onChange:ne},{default:a(()=>[(i(!0),T(L,null,U(u(_).db,s=>(i(),y(c,{key:s},{default:a(()=>[p(d(s),1)]),_:2},1024))),128))]),_:1},8,["value"])]),_:1},8,["label"]),t(n,{label:e.$t("common.table.table")},{default:a(()=>[t(C,{value:u(l).table,"onUpdate:value":o[1]||(o[1]=s=>u(l).table=s),"dropdown-match-select-width":!1,"show-search":""},{default:a(()=>[(i(!0),T(L,null,U(u(_).table,s=>(i(),y(c,{key:s},{default:a(()=>[p(d(s),1)]),_:2},1024))),128))]),_:1},8,["value"])]),_:1},8,["label"]),t(n,{label:e.$t("common.table.remark"),name:"text"},{default:a(()=>[t(V,{value:u(l).text,"onUpdate:value":o[2]||(o[2]=s=>u(l).text=s),rows:3,"show-count":"","allow-clear":""},null,8,["value"])]),_:1},8,["label"]),t(n,{label:e.$t("order.profile.timing")},{default:a(()=>[t($,{"show-time":"","disabled-date":te,"disabled-time":oe,onOk:le})]),_:1},8,["label"]),t(n,{label:e.$t("order.profile.roll")},{default:a(()=>[t(B,{value:u(l).backup,"onUpdate:value":o[3]||(o[3]=s=>u(l).backup=s),name:"radioGroup"},{default:a(()=>[t(q,{value:1},{default:a(()=>[p(d(e.$t("common.yes")),1)]),_:1}),t(q,{value:0},{default:a(()=>[p(d(e.$t("common.no")),1)]),_:1})]),_:1},8,["value"])]),_:1},8,["label"]),t(n,{label:e.$t("common.action")},{default:a(()=>[t(pe,null,{default:a(()=>[t(E,{loading:S.value,onClick:se},{default:a(()=>[p(d(e.$t("order.apply.table.info")),1)]),_:1},8,["loading"]),t(E,{loading:v.value,disabled:w.value,onClick:ue},{default:a(()=>[p(d(e.$t("common.commit")),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["label"])]),_:1},16,["model"])]),_:1})]),_:1}),t(Y,{sm:24,md:24,xl:18},{default:a(()=>[t(R,null,{default:a(()=>[t(be,{activeKey:D.value,"onUpdate:activeKey":o[5]||(o[5]=s=>D.value=s)},{default:a(()=>[(i(),y(O,{key:1,tab:e.$t("order.apply.tab.sql"),"force-render":""},{default:a(()=>[t(_e,{spinning:g.value,delay:100},{default:a(()=>[b("div",Je,[t(Be,{ref_key:"editor",ref:k,"container-id":"apply",onGetValues:u(re),onChangeContent:o[4]||(o[4]=()=>w.value?null:w.value=!0)},null,8,["onGetValues"])]),Qe,t(I,{columns:u(Z),"data-source":M.value,bordered:"","row-key":"sql"},null,8,["columns","data-source"])]),_:1},8,["spinning"])]),_:1},8,["tab"])),(i(),y(O,{key:2,tab:e.$t("order.apply.tab.table"),"force-render":""},{default:a(()=>[t(I,{columns:u(ee),"data-source":F.value,bordered:"",scroll:{y:400},"row-key":"field"},null,8,["columns","data-source"])]),_:1},8,["tab"])),(i(),y(O,{key:3,tab:e.$t("order.apply.tab.index")},{default:a(()=>[t(I,{columns:u(ae),"data-source":G.value,bordered:"","row-key":"IndexName"},{bodyCell:a(({column:s,text:we})=>[s.dataIndex==="NonUnique"?(i(),T(L,{key:0},[p(d(we===0?e.$t("common.yes"):e.$t("common.no")),1)],64)):Me("v-if",!0)]),_:1},8,["columns","data-source"])]),_:1},8,["tab"]))]),_:1},8,["activeKey"]),ze,t(ge,{size:"small","progress-dot":""},{default:a(()=>[(i(!0),T(L,null,U(u(_).timeline,s=>(i(),y(ve,{key:s.desc,title:s.desc,status:"process"},{subTitle:a(()=>[t(ye,{placement:"top"},{title:a(()=>[b("span",null,d(e.$t("common.relevant"))+": "+d(s.auditor.join(" ")),1)]),default:a(()=>[p(" "+d(u(W)(s.type)),1)]),_:2},1024)]),_:2},1032,["title"]))),128))]),_:1})]),_:1})]),_:1})]),_:1})],64)}}}),ra=Ve(We,[["__file","F:/inf/Yearning/gemini-next/src/views/apply/order.vue"]]);export{ra as default};
